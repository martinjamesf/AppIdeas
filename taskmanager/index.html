<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Manager - Organize your tasks</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9f9f9;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .actions button,
    .actions select {
      padding: 0.5rem 1rem;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .actions select {
      background: #eee;
      color: black;
    }

    .bulk-actions {
      display: none;
      margin-bottom: 1rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .bulk-actions.active {
      display: flex;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th,
    td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
      vertical-align: middle;
    }

    th {
      background: #f0f0f0;
    }

    .drag-handle {
      cursor: move;
      color: #666;
      padding: 0 0.5rem;
    }

    td input,
    td select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    td input[type="text"] {
      font-size: 1rem;
    }

    th:first-child,
    td:first-child {
      width: 2rem;
      text-align: center;
      vertical-align: middle;
    }

    input[type="checkbox"] {
      vertical-align: middle;
      width: 1rem;
      height: 1rem;
      accent-color: #007BFF;
      /* Matches your theme */
    }

    .task-link {
      color: #007BFF;
      cursor: pointer;
      text-decoration: underline;
    }

    .modal {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 1.5rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      width: 400px;
    }

    .modal.active {
      display: block;
    }

    .modal h3 {
      margin-top: 0;
    }

    .modal input {
      margin-top: 0.5rem;
      width: 100%;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    .modal label {
      display: block;
      margin-top: 0.8rem;
      font-weight: bold;
    }

    .modal input,
    .modal select,
    .modal textarea {
      margin-top: 0.3rem;
      width: 100%;
      padding: 0.4rem;
      font-size: 1rem;
      box-sizing: border-box;
    }
  </style>
</head>

<body>

  <div class="actions">
    <button id="addTask">Add Task</button>
    <select id="applyWorkflow">
      <option value="">Apply Workflow</option>
      <option value="risk">Risk Policy Opening</option>
      <option value="fourk">401(k) Rollover</option>
      <option value="wealth">Wealth Account Opening</option>
    </select>
    <button id="toggleEdit">Edit</button>
  </div>

  <div class="bulk-actions" id="bulkActions">
    <select id="bulkGroup">
      <option value="">Group by</option>
      <option value="Independent">Independent</option>
      <option value="Sequential">Sequential</option>
      <option value="Parallel">Parallel</option>
    </select>

    <select id="bulkStatus">
      <option value="">Status</option>
      <option value="Not Started">Not Started</option>
      <option value="In Progress">In Progress</option>
      <option value="Completed">Completed</option>
      <option value="Waiting on Someone">Waiting on Someone</option>
    </select>

    <button id="bulkDelete">Delete</button>
  </div>

  <table id="taskTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" /></th>
        <th></th>
        <th>#</th>
        <th>Task Name</th>
        <th>Status</th>
        <th>Group</th>
        <th>Task Creation Sequence</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="overlay" id="modalOverlay"></div>
  <div class="modal" id="taskModal">
    <h3>Edit Task</h3>
    <label>Client/Business Name</label>
    <input id="modalClientName" type="text" />

    <label>Task Name</label>
    <input id="modalTaskName" type="text" />

    <label>Assigned To</label>
    <select id="modalAssignedTo">
      <option value="">Select</option>
      <option>James</option>
      <option>Josie</option>
      <option>Michael</option>
      <option>Neha</option>
      <option>Catelyn</option>
    </select>

    <label>Status</label>
    <select id="modalStatus">
      <option>Not Started</option>
      <option>In Progress</option>
      <option>Completed</option>
      <option>Waiting on Someone</option>
    </select>

    <label>Start Date</label>
    <input id="modalStartDate" type="date" />

    <label>Due Date</label>
    <input id="modalDueDate" type="date" />

    <label>Sub-type</label>
    <input id="modalSubtype" type="text" />

    <label>Priority</label>
    <select id="modalPriority">
      <option>Low</option>
      <option>Medium</option>
      <option>High</option>
    </select>

    <label>Comments</label>
    <textarea id="modalComments" rows="3"></textarea>

    <button onclick="closeModal()">Close</button>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const taskTableBody = document.getElementById("taskTableBody");
      const editToggle = document.getElementById("editToggle");
      const applyWorkflowBtn = document.getElementById("applyWorkflow");
      const downloadBtn = document.getElementById("downloadBtn");
      const uploadInput = document.getElementById("uploadInput");

      let isEditing = false;

      const defaultTask = {
        name: "New Task",
        type: "Independent",
        sequence: "",
        notes: ""
      };

      const workflowTemplates = {
        "Risk Policy Opening": [
          { name: "eSignature", type: "Independent", sequence: "", notes: "" },
          { name: "Application", type: "Sequential", sequence: "", notes: "" },
          { name: "Verification", type: "Parallel", sequence: "", notes: "" }
        ],
        "Wealth Account Opening": [
          { name: "eSignature", type: "Independent", sequence: "", notes: "" },
          { name: "Application", type: "Sequential", sequence: "", notes: "" },
          { name: "Funding", type: "Parallel", sequence: "", notes: "" }
        ]
      };

      function addTask(task = defaultTask) {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td class="handle" style="cursor: grab;">‚ò∞</td>
          <td class="task-number"></td>
          <td><select ${!isEditing ? "disabled" : ""}>
            <option value="Independent"${task.type === "Independent" ? " selected" : ""}>Independent</option>
            <option value="Sequential"${task.type === "Sequential" ? " selected" : ""}>Sequential</option>
            <option value="Parallel"${task.type === "Parallel" ? " selected" : ""}>Parallel</option>
          </select></td>
          <td>${isEditing ? `<input type="text" value="${task.name}">` : `<a href="#">${task.name}</a>`}</td>
          <td><input type="text" value="${task.sequence}" ${!isEditing ? "readonly" : ""}></td>
          <td>${isEditing ? `<textarea>${task.notes}</textarea>` : `<span>${task.notes}</span>`}</td>
          <td><button class="delete">üóëÔ∏è</button></td>
        `;

        row.querySelector(".delete").addEventListener("click", () => {
          row.remove();
          saveToLocalStorage();
          updateTaskNumbers();
        });

        row.querySelector("a")?.addEventListener("click", (e) => {
          e.preventDefault();
          openModal(row);
        });

        taskTableBody.appendChild(row);
        updateTaskNumbers();
        enforceApplicationAfterESignature();
        saveToLocalStorage();
      }

      function updateTaskNumbers() {
        const rows = Array.from(taskTableBody.children);
        let groupCount = 1;

        for (let i = 0; i < rows.length; i++) {
          const type = rows[i].querySelector("select").value;
          const cell = rows[i].querySelector(".task-number");

          // If this is the start of a new group
          if (type === "Independent") {
            cell.textContent = `${groupCount}`;
            groupCount++;
          } else if (type === "Sequential") {
            let subCount = 1;
            cell.textContent = `${groupCount - 1}.${subCount}`;
            for (let j = i + 1; j < rows.length && rows[j].querySelector("select").value === "Sequential"; j++) {
              subCount++;
              rows[j].querySelector(".task-number").textContent = `${groupCount - 1}.${subCount}`;
              i = j;
            }
          } else if (type === "Parallel") {
            cell.textContent = `${groupCount - 1}`;
            for (let j = i + 1; j < rows.length && rows[j].querySelector("select").value === "Parallel"; j++) {
              rows[j].querySelector(".task-number").textContent = `${groupCount - 1}`;
              i = j;
            }
          }
        }
      }

      function saveToLocalStorage() {
        const tasks = Array.from(taskTableBody.children).map(row => ({
          type: row.querySelector("select").value,
          name: row.querySelector("input[type='text'], a").value || row.querySelector("a")?.textContent,
          sequence: row.querySelector("td:nth-child(5) input").value,
          notes: isEditing ? row.querySelector("textarea").value : row.querySelector("span").textContent
        }));
        localStorage.setItem("taskManagerData", JSON.stringify(tasks));
      }

      function loadFromLocalStorage() {
        const tasks = JSON.parse(localStorage.getItem("taskManagerData") || "[]");
        tasks.forEach(addTask);
      }

      function enforceApplicationAfterESignature() {
        const taskRows = Array.from(taskTableBody.querySelectorAll("tr"));
        const eSigIndex = taskRows.findIndex(row =>
          (row.querySelector("td:nth-child(4) input")?.value || row.querySelector("td:nth-child(4) a")?.textContent)?.trim() === "eSignature"
        );
        const appIndex = taskRows.findIndex(row =>
          (row.querySelector("td:nth-child(4) input")?.value || row.querySelector("td:nth-child(4) a")?.textContent)?.trim() === "Application"
        );

        if (appIndex === -1) return;

        const appRow = taskRows[appIndex];
        const typeCell = appRow.querySelector("td:nth-child(3) select");

        if (typeCell && typeCell.value !== "Sequential") {
          typeCell.value = "Sequential";
          typeCell.dispatchEvent(new Event('change'));
        }

        if (eSigIndex !== -1 && appIndex !== eSigIndex + 1) {
          const tbody = document.getElementById("taskTableBody");
          tbody.removeChild(appRow);
          const target = taskRows[eSigIndex + 1]?.nextSibling || null;
          tbody.insertBefore(appRow, target);
        }

        updateTaskNumbers();
      }

      editToggle.addEventListener("click", () => {
        isEditing = !isEditing;
        editToggle.textContent = isEditing ? "Save" : "Edit";
        rebuildTableFromDOM();
      });

      applyWorkflowBtn.addEventListener("change", () => {
        const selected = applyWorkflowBtn.value;
        if (workflowTemplates[selected]) {
          taskTableBody.innerHTML = "";
          workflowTemplates[selected].forEach(addTask);
          applyWorkflowBtn.selectedIndex = 0;
        }
      });

      downloadBtn.addEventListener("click", () => {
        const data = localStorage.getItem("taskManagerData");
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "tasks.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      uploadInput.addEventListener("change", () => {
        const file = uploadInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const tasks = JSON.parse(e.target.result);
          taskTableBody.innerHTML = "";
          tasks.forEach(addTask);
        };
        reader.readAsText(file);
      });

      function rebuildTableFromDOM() {
        const tasks = Array.from(taskTableBody.children).map(row => ({
          type: row.querySelector("select").value,
          name: row.querySelector("input[type='text'], a").value || row.querySelector("a")?.textContent,
          sequence: row.querySelector("td:nth-child(5) input").value,
          notes: isEditing ? row.querySelector("textarea").value : row.querySelector("span").textContent
        }));

        taskTableBody.innerHTML = "";
        tasks.forEach(addTask);
      }

      loadFromLocalStorage();

      // Make table sortable
      new Sortable(taskTableBody, {
        handle: ".handle",
        animation: 150,
        onEnd: () => {
          enforceApplicationAfterESignature();
          updateTaskNumbers();
          saveToLocalStorage();
        }
      });
    });
  </script>

</body>

</html>