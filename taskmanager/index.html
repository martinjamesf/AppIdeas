<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Manager</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css" />
  <style>
    td input, td select {
      width: 100%;
    }
    td:first-child {
      font-weight: bold;
    }
    a {
      cursor: pointer;
      color: var(--primary);
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Task Manager</h1>

    <div class="grid">
      <button id="toggleEdit">Edit</button>
      <select id="applyWorkflow">
        <option value="">Apply Workflow</option>
        <option value="Risk Policy Opening">Risk Policy Opening</option>
        <option value="Wealth Account Opening">Wealth Account Opening</option>
      </select>
      <button id="downloadBtn">Download JSON</button>
      <input type="file" id="uploadInput" accept=".json" />
    </div>

    <table id="taskTable" role="grid">
      <thead>
        <tr>
          <th>#</th>
          <th>Task Creation Sequence</th>
          <th>Type</th>
          <th>Task Name</th>
          <th>Description</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        <!-- Tasks will be dynamically added here -->
      </tbody>
    </table>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    const taskTable = document.getElementById("taskTable");
    const taskTableBody = taskTable.querySelector("tbody");
    const editToggleBtn = document.getElementById("toggleEdit");
    const applyWorkflowBtn = document.getElementById("applyWorkflow");
    const downloadBtn = document.getElementById("downloadBtn");
    const uploadInput = document.getElementById("uploadInput");

    let isEditing = false;

    function attachNameLinkListener(anchor, row) {
      anchor.addEventListener("click", (e) => {
        e.preventDefault();
        openTaskModal(row);
      });
    }

    function createTaskRow(task = {}) {
      const row = document.createElement("tr");

      const idCell = document.createElement("td");
      idCell.textContent = "";

      const seqCell = document.createElement("td");
      const seqInput = document.createElement("input");
      seqInput.type = "text";
      seqInput.value = task.creationSequence || "";
      seqCell.appendChild(seqInput);

      const typeCell = document.createElement("td");
      const typeSelect = document.createElement("select");
      ["Independent", "Sequential", "Parallel"].forEach(type => {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        if (task.type === type) option.selected = true;
        typeSelect.appendChild(option);
      });
      typeCell.appendChild(typeSelect);

      const nameCell = document.createElement("td");
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = task.name || "";
      const nameLink = document.createElement("a");
      nameLink.href = "#";
      nameLink.textContent = task.name || "";
      attachNameLinkListener(nameLink, row);
      nameCell.appendChild(isEditing ? nameInput : nameLink);

      const descCell = document.createElement("td");
      const descInput = document.createElement("input");
      descInput.type = "text";
      descInput.value = task.description || "";
      descCell.appendChild(descInput);

      const deleteCell = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ðŸ—‘";
      deleteBtn.className = "outline contrast";
      deleteBtn.addEventListener("click", () => {
        row.remove();
        updateTaskNumbers();
        saveToLocalStorage();
      });
      deleteCell.appendChild(deleteBtn);

      row.append(idCell, seqCell, typeCell, nameCell, descCell, deleteCell);
      return row;
    }

    function addTask(task = {}) {
      const row = createTaskRow(task);
      taskTableBody.appendChild(row);
      updateTaskNumbers();
      saveToLocalStorage();
      enforceApplicationAfterESignature();
    }

    function updateTaskNumbers() {
      const rows = Array.from(taskTableBody.querySelectorAll("tr"));
      let groupCounter = 1;
      let subCounter = 1;
      let previousType = "";

      rows.forEach((row, index) => {
        const type = row.querySelector("select").value;
        const cell = row.querySelector("td");

        if (type === "Independent") {
          cell.textContent = groupCounter++;
          subCounter = 1;
        } else if (type === "Sequential") {
          if (previousType === "Sequential") {
            cell.textContent = `${groupCounter - 1}.${subCounter++}`;
          } else {
            subCounter = 1;
            cell.textContent = `${groupCounter}.${subCounter++}`;
            groupCounter++;
          }
        } else if (type === "Parallel") {
          if (previousType === "Parallel") {
            cell.textContent = `${groupCounter - 1}`;
          } else {
            cell.textContent = `${groupCounter++}`;
          }
        }

        previousType = type;
      });
    }

    function toggleEditMode() {
      isEditing = !isEditing;
      editToggleBtn.textContent = isEditing ? "Save" : "Edit";

      Array.from(taskTableBody.querySelectorAll("tr")).forEach(row => {
        const nameCell = row.querySelector("td:nth-child(4)");
        const currentName = nameCell.textContent.trim();
        nameCell.innerHTML = "";

        if (isEditing) {
          const input = document.createElement("input");
          input.type = "text";
          input.value = currentName;
          nameCell.appendChild(input);
        } else {
          const anchor = document.createElement("a");
          anchor.href = "#";
          anchor.textContent = nameCell.querySelector("input").value;
          attachNameLinkListener(anchor, row);
          nameCell.appendChild(anchor);
        }
      });

      saveToLocalStorage();
    }

    function saveToLocalStorage() {
      const tasks = Array.from(taskTableBody.querySelectorAll("tr")).map(row => ({
        creationSequence: row.querySelector("td:nth-child(2) input").value,
        type: row.querySelector("td:nth-child(3) select").value,
        name: isEditing
          ? row.querySelector("td:nth-child(4) input").value
          : row.querySelector("td:nth-child(4) a").textContent,
        description: row.querySelector("td:nth-child(5) input").value,
      }));
      localStorage.setItem("taskManagerData", JSON.stringify(tasks));
    }

    function loadFromLocalStorage() {
      const data = JSON.parse(localStorage.getItem("taskManagerData") || "[]");
      data.forEach(addTask);
      enforceApplicationAfterESignature();
    }

    function enforceApplicationAfterESignature() {
      const taskRows = Array.from(taskTableBody.querySelectorAll("tr"));

      let eSigRow = null;
      let appRow = null;

      taskRows.forEach(row => {
        const nameCell = row.querySelector("td:nth-child(4)");
        const name = nameCell.querySelector("input")?.value?.trim() ||
          nameCell.querySelector("a")?.textContent?.trim() || "";

        if (name === "eSignature") {
          eSigRow = row;
        } else if (name === "Application") {
          appRow = row;
        }
      });

      if (!appRow) return;

      const typeSelect = appRow.querySelector("select");
      if (typeSelect.value !== "Sequential") {
        typeSelect.value = "Sequential";
        typeSelect.dispatchEvent(new Event("change"));
      }

      if (eSigRow && eSigRow !== appRow.previousElementSibling) {
        const nextSibling = eSigRow.nextSibling;
        taskTableBody.removeChild(appRow);
        taskTableBody.insertBefore(appRow, nextSibling);
      }

      updateTaskNumbers();
    }

    function openTaskModal(row) {
      alert("Modal for task: " + (isEditing
        ? row.querySelector("td:nth-child(4) input").value
        : row.querySelector("td:nth-child(4) a").textContent));
    }

    editToggleBtn.addEventListener("click", toggleEditMode);

    downloadBtn.addEventListener("click", () => {
      const data = localStorage.getItem("taskManagerData");
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "tasks.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    uploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const tasks = JSON.parse(reader.result);
        taskTableBody.innerHTML = "";
        tasks.forEach(addTask);
        enforceApplicationAfterESignature();
      };
      reader.readAsText(file);
    });

    applyWorkflowBtn.addEventListener("change", () => {
      const selected = applyWorkflowBtn.value;
      applyWorkflowBtn.value = "";
      if (selected === "Risk Policy Opening") {
        addTask({ name: "Open Case", type: "Independent" });
        addTask({ name: "eSignature", type: "Sequential" });
        addTask({ name: "Application", type: "Sequential" });
        addTask({ name: "Underwriting", type: "Parallel" });
      } else if (selected === "Wealth Account Opening") {
        addTask({ name: "Open Case", type: "Independent" });
        addTask({ name: "eSignature", type: "Sequential" });
        addTask({ name: "Application", type: "Sequential" });
        addTask({ name: "Delivery", type: "Parallel" });
      }
      enforceApplicationAfterESignature();
    });

    new Sortable(taskTableBody, {
      animation: 150,
      onEnd: () => {
        enforceApplicationAfterESignature();
        updateTaskNumbers();
        saveToLocalStorage();
      },
    });

    loadFromLocalStorage();
  </script>
</body>
</html>
